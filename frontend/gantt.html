<!DOCTYPE html>
<html>
<body>

<!-- <h1>My First JavaScript</h1>

<button type="button"
onclick="document.getElementById('demo').innerHTML = Date()">
Click me to display Date and Time.</button>

<p id="demo"></p> -->


<!-- <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" /> -->

<script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-core.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-gantt.min.js" type="text/javascript"></script>

<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>



<!-- <script type="text/javascript" src="./example_data.js"></script> -->




<label for="project_baseline">Select baseline:</label>
<select id="project_baseline" onchange='project_baseline_change();'><option value=""></option></select>

<label for="project_baseline_compare">Select compare baseline:</label>
<select id="project_baseline_compare" onchange='project_baseline_change();'><option value=""></option></select>



<script type="text/babel" class="code-js">

    var gridData = []

    const url = 'http://localhost:8080/graphql'




    var query = `query {
        queryProject (filter: {has: baselines}) {
            id
            name
            baselines {
            id
            name
            }
        }
    }`


    fetch(url, {
        method: 'post',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query })
    })
    .then(res => res.json())
    .then(function (rjs) {
        function update_selector(selector_label) {
            for (var i in rjs['data']['queryProject']) {
                var optgroup = document.createElement('optgroup');
                optgroup.label = rjs['data']['queryProject'][i]['name']

                document.querySelector(selector_label).add(optgroup, null)
                
                for (var j in rjs['data']['queryProject'][i]['baselines']) {
                    var option = document.createElement('option')
                    option.project_id = rjs['data']['queryProject'][i]['id']
                    option.baseline_id = rjs['data']['queryProject'][i]['baselines'][j]['id']
                    option.text = '- ' + rjs['data']['queryProject'][i]['baselines'][j]['name']

                    document.querySelector(selector_label).add(option, null)
                }
            }
        }

        update_selector('#project_baseline')
        update_selector('#project_baseline_compare')
    })
    .catch(console.error);




    function get_pose(project_id, list_of_projects) {
        for (var i = 0; i < list_of_projects.length; i++) {
            if (list_of_projects[i]['project']['id'] == project_id) {
                return i;
            }
        }
        return null;
    }



    function parse_response_project_query(response) {
        var formatted = []
        var s;
        for (s in response['data']['queryProject']) {
            if (response['data']['queryProject'][s]['baselines'].length == 0) {
                continue
            }
            var projects = response['data']['queryProject'][s]['baselines'][0]['projects'];
            var p;
            for (p in projects) {
                var project = {
                    'id': projects[p]['project']['id'],
                    'wbs': projects[p]['wbs'], 
                    'name': projects[p]['project']['name'], 
                    'description': projects[p]['project']['description'], 
                    'actualStart': projects[p]['start'], 
                    'actualEnd': projects[p]['finish'], 
                    'actual_worktime': projects[p]['worktime'],
                }

                if (projects[p]['parent']) {
                    project['parent'] = projects[p]['parent']['project']['id']
                }

                if (projects[p]['project']['customFields']) {
                    var custom = JSON.parse(projects[p]['project']['customFields'])
                    var pr;
                    for (pr in custom) {
                        project[pr] = custom[pr]
                    }
                }

                if (project['wbs'] == null) { 
                    project['collapsed'] = false 
                    project['wbs'] = '' 
                }
                else { project['collapsed'] = true }

                if (project['actual_worktime'] == null) {
                    project['actual_worktime'] = ''
                }

                if ('jira_id' in project) {
                    project['jira_link'] = "https://tangramcare.atlassian.net/browse/" + project['jira_id']
                }

                formatted.push(project)
            }

            for (p in projects) {
                var pred;
                for (pred in projects[p]['predecessors']) {
                    var form;
                    for (form in formatted) {
                        if (formatted[form]['id'] == projects[p]['predecessors'][pred]['project']['project']['id']) {
                            formatted[form]['connectTo'] = projects[p]['project']['id']
                            if (projects[p]['predecessors'][pred]['type'] == 'FS') { formatted[form]['connectorType'] = "finish-start" }
                            if (projects[p]['predecessors'][pred]['type'] == 'SF') { formatted[form]['connectorType'] = "start-finish" }
                            if (projects[p]['predecessors'][pred]['type'] == 'SS') { formatted[form]['connectorType'] = "start-start" }
                            if (projects[p]['predecessors'][pred]['type'] == 'FF') { formatted[form]['connectorType'] = "finish-finish" }
                        }
                    }
                }
            }
        }

        return formatted
    }


    var anychart_data = []

    function refresh_anychart_data() {
        if (anychart_data){
                var treeData = anychart.data.tree(anychart_data, "as-table");  
                chart.data(treeData);
                chart.fitAll();
            }
    }


    function get_project_baseline(project_id, baseline_id) {    
        var query = `{
            queryProject (filter: {id: ["` + project_id + `"]}) {
            name
                baselines (filter: {id: ["` + baseline_id + `"]}) {
                    name
                    projects (order: {asc: start}) {
                        project {id name description customFields}
                        wbs
                        worktime
                        start
                        finish
                        parent {project {id}}
                        predecessors {type project {project {id}}}
                    }
                }
            }
        }`

        fetch(url, {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query })
        })
        .then(res => res.json())
        .then(function (rjs) {
            anychart_data = parse_response_project_query(rjs)
            
            refresh_anychart_data()
        })
        .catch(console.error);
    }










    var chart = anychart.ganttProject(); 
    
    var buttons = chart.dataGrid().buttons();
    // configure data grid buttons in the normal state
    buttons.normal().content("+");
    buttons.normal().fontColor("#ef6c00");

    // configure data grid buttons in the hover state
    buttons.hovered().content("+");
    buttons.hovered().fontColor(anychart.color.lighten("#ef6c00"));

    // configure data grid buttons in the selected state
    buttons.selected().content("-");
    buttons.selected().fontColor("#64b5f6");

    chart.dataGrid().column(0).labels().format("");
    chart.dataGrid().column(0).collapseExpandButtons(true);
    chart.dataGrid().column(0).width(10);

    chart.dataGrid().column(1).title().text("Jira ID");
    chart.dataGrid().column(1).depthPaddingMultiplier(0);
    chart.dataGrid().column(1).collapseExpandButtons(false);
    chart.dataGrid().column(1).width(60);
    chart.dataGrid().column(1).labels().useHtml(true);
    chart.dataGrid().column(1).labels().format("<a href='{%jira_link}'>{%jira_id}</a>");


    chart.dataGrid().column(2).title().text("Name")
    chart.dataGrid().column(2).labels().format("{%name}");
    chart.dataGrid().column(2).width(400);

    chart.dataGrid().column(3).title().text("Actual worktime")
    chart.dataGrid().column(3).labels().format("{%actual_worktime}");
    chart.dataGrid().column(3).width(40);

    chart.dataGrid().column(4).title().text("Compare worktime")
    chart.dataGrid().column(4).labels().format("{%planned_time}");
    chart.dataGrid().column(4).width(40);

    chart.splitterPosition("567px");

    // chart.getTimeline().tooltip().format(
    //     "Start: {%actual_development_time_start}\nFinish: {%actual_development_time_finish}"
    // )

    chart.container("container");
    chart.draw();
    chart.fitAll();
  




function project_baseline_change() {
    var actual_baseline_selector = document.querySelector('#project_baseline').selectedOptions[0]

    get_project_baseline(actual_baseline_selector.project_id, actual_baseline_selector.baseline_id)
}



</script>

<div style="height: 700px;" id="container"></div>

</body>
</html> 
